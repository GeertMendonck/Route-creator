<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geo Route Builder (v1.0)</title>

  <!-- Leaflet (CDN) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Arial; }
    .wrap{ display:flex; height:100vh; }
    .left{ width:560px; min-width:320px; max-width:760px; overflow:auto; border-right:1px solid #ddd; padding:12px; box-sizing:border-box; }
    .right{ flex:1; position:relative; }
    #map{ position:absolute; inset:0; }
    h2{ margin:6px 0 10px; font-size:18px; }
    h3{ margin:14px 0 8px; font-size:14px; opacity:.85; }
    label{ display:block; font-size:12px; margin:6px 0 2px; opacity:.85; }
    input[type="text"], input[type="number"], textarea, select{
      width:100%; box-sizing:border-box; padding:8px; border:1px solid #ccc; border-radius:8px;
    }
    textarea{ min-height:60px; resize:vertical; }
    .row{ display:flex; gap:8px; }
    .row > div{ flex:1; }
    .btnbar{ display:flex; gap:8px; flex-wrap:wrap; margin:10px 0; }
    button{
      padding:8px 10px; border:1px solid #bbb; background:#fff; border-radius:10px; cursor:pointer;
    }
    button:hover{ background:#f6f6f6; }
    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th, td{ border-bottom:1px solid #eee; padding:6px 4px; vertical-align:top; }
    th{ text-align:left; position:sticky; top:0; background:#fff; z-index:1; }
    .mini{ font-size:11px; opacity:.75; }
    .pill{
      display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:11px; margin-left:6px;
    }
    .err{ color:#b00020; }
    .warn{ color:#8a5a00; }
    .ok{ color:#0a7a2f; }
    .note{ background:#f7f7f7; border:1px solid #e9e9e9; padding:8px; border-radius:10px; }
    .split{ display:flex; gap:8px; align-items:center; }
    .split input[type="checkbox"]{ transform:scale(1.1); }
    .linklike{ color:#0b63ce; cursor:pointer; text-decoration:underline; }
  .left{
  width:560px;
  max-width:760px;
  resize: horizontal;
  overflow:auto;
}

.locLabelIcon { background: transparent; border: none; }
.locLabelBubble{
  transform: translate(-50%, -38px);
  padding: 2px 6px;
  border-radius: 10px;
  border: 1px solid #cfcfcf;
  background: rgba(255,255,255,.92);
  font-size: 11px;
  white-space: nowrap;
  box-shadow: 0 1px 4px rgba(0,0,0,.12);
}

  </style>
</head>

<body>
<div class="wrap">
  <div class="left">
    <h2>Geo Route Builder <span class="pill">v1</span></h2>
    <div class="note mini">
      Klik op de kaart om een locatie toe te voegen. Sleep markers om lat/lng te wijzigen.
      Gebruik ‚ÄúExport‚Äù om je JSON te downloaden.
    </div>

    <div class="btnbar">
      <button id="btnNew">Nieuw</button>
      <button id="btnExport">Export JSON</button>
      <label style="display:inline-block">
        <input id="fileImport" type="file" accept=".json" style="display:none">
        <button id="btnImport">Import JSON</button>
      </label>
    </div>

    <h3>Meta</h3>
    <label>Titel</label>
    <input id="metaTitle" type="text" />
    <label>Subtitel</label>
    <input id="metaSubtitle" type="text" />
    <label>Versie</label>
    <input id="metaVersion" type="text" />

    <div class="split" style="margin-top:8px">
      <input id="metaCharactersEnabled" type="checkbox">
      <div style="flex:1">
        <div><b>Personages gebruiken</b> <span class="pill mini">optioneel</span></div>
        <div class="mini">Als je dit aanzet, exporteren we <code>meta.characters</code> mee.</div>
      </div>
    </div>
    <div id="metaCharactersBox" style="display:none; margin-top:6px">
      <label>Personages bronbestand</label>
      <input id="metaCharactersSource" type="text" placeholder="personages.json" />
    </div>

    <h3>Settings</h3>
    <label>visibilityMode</label>
    <select id="setVisibilityMode">
      <option value="nextOnly">nextOnly</option>
      <option value="allAfterStart">allAfterStart</option>
      <option value="all">all</option>
    </select>

    <label>multiLocationSlotMode</label>
    <select id="setMultiLocSlotMode">
      <option value="any">any</option>
      <option value="random">random</option>
      <option value="nearest">nearest</option>
      <option value="all">all</option>
    </select>

    <div class="row" style="margin-top:8px">
      <div class="split"><input id="setShowOptionalSlots" type="checkbox"><div>showOptionalSlots</div></div>
      <div class="split"><input id="setListShowFutureSlots" type="checkbox"><div>listShowFutureSlots</div></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="split"><input id="setMapShowFutureLocations" type="checkbox"><div>mapShowFutureLocations</div></div>
      <div></div>
    </div>

    <h3>Prestart</h3>
    <label>useLocationId</label>
    <select id="preUseLocationId"></select>

    <label>meetingPoint label</label>
    <input id="preMeetingLabel" type="text" placeholder="Aan de voordeur" />

    <div class="row">
      <div>
        <label>meetingPoint lat</label>
        <input id="preMeetingLat" type="number" step="any" />
      </div>
      <div>
        <label>meetingPoint lng</label>
        <input id="preMeetingLng" type="number" step="any" />
      </div>
    </div>

    <div class="btnbar">
      <button id="btnSetMeetingPoint">Meeting point zetten via kaartklik</button>
    </div>
    <div class="btnbar">
    <button id="btnMakePrestartStartSlot">Maak prestart = startslot + startlocatie</button>
    </div>


    <label>message</label>
    <textarea id="preMessage"></textarea>

    <label>maps.label</label>
    <input id="preMapsLabel" type="text" placeholder="Route naar startpunt" />
    <button id="btnSyncPrestartStart">Sync prestart ‚Üí startslot+startloc (veilig)</button>

    <h3>Slots</h3>
    <div class="btnbar">
      <button id="btnAddSlot">+ Slot</button>
    </div>
    <table id="slotsTable">
      <thead>
        <tr>
          <th style="width:18%">id</th>
          <th style="width:22%">label</th>
          <th style="width:10%">req</th>
          <th style="width:25%">unlockAfter</th>
          <th style="width:15%">completeMode</th>
          <th style="width:10%"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Locaties</h3>
    <div class="note mini" style="margin:8px 0">
     Klik op de kaart om een locatie toe te voegen.
    </div>

    <table id="locsTable">
      <thead>
        <tr>
          <th style="width:22%">id</th>
          <th style="width:18%">slot</th>
          <th style="width:20%">naam</th>
          <th style="width:10%">rad</th>
          <th style="width:20%">lat/lng</th>
          <th style="width:10%"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Controle</h3>
    <div id="validationBox" class="note mini"></div>

    <div class="mini" style="margin-top:10px; opacity:.7">
      Tip: klik een locatie in de tabel om er naartoe te zoomen op de kaart.
    </div>
  </div>

  <div class="right">
    <div id="map"></div>
  </div>
</div>

<script>
(function(){
  'use strict';

  // --------- Data model ----------
  function defaultData(){
    return {
      meta: {
        title: 'Nieuwe route',
        subtitle: '',
        version: '1.0'
        // characters optioneel
      },
      settings: {
        visibilityMode: 'nextOnly',
        multiLocationSlotMode: 'all',
        showOptionalSlots: true,
        listShowFutureSlots: true,
        mapShowFutureLocations: false
      },
      prestart: {
        useLocationId: '',
        meetingPoint: { lat: 51.220418, lng: 4.440854, label: 'Aan de voordeur' },
        message: 'Nog niet aan het startpunt. Ga naar de startlocatie om te beginnen.',
        maps: { label: 'Route naar startpunt' },
        images: []
      },
      slots: [
        { id:'start', label:'Start', required:true }
      ],
      locaties: []
    };
  }

  var DATA = defaultData();

  // --------- Map ----------
  var map = L.map('map').setView([51.220418, 4.440854], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  var markerLayer = L.layerGroup().addTo(map);
  var meetingMarker = null;

  // locationId -> {marker, circle}
  var locRender = {};

  var meetingPickMode = false;

  map.on('click', function(e){
    if(meetingPickMode){
      meetingPickMode = false;
      setMeetingPoint(e.latlng.lat, e.latlng.lng);
      renderMeetingMarker();
      return;
    }
    // add location by map click
    addLocFromMap(e.latlng.lat, e.latlng.lng);
  });

  // --------- Helpers ----------
  function byId(id){ return document.getElementById(id); }
  function esc(s){
    s = (s==null ? '' : String(s));
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function uniqueId(prefix, list, key){
    var i=1, id;
    do{
      id = prefix + String(i).padStart(2,'0');
      i++;
    }while(existsIn(list, key, id));
    return id;
  }
  function existsIn(list, key, value){
    for(var i=0;i<list.length;i++){
      if(list[i] && list[i][key] === value) return true;
    }
    return false;
  }
  function findLocById(id){
    for(var i=0;i<DATA.locaties.length;i++){
      if(DATA.locaties[i].id===id) return DATA.locaties[i];
    }
    return null;
  }
  function slotIds(){
    var ids=[];
    for(var i=0;i<DATA.slots.length;i++){
      if(DATA.slots[i] && DATA.slots[i].id) ids.push(DATA.slots[i].id);
    }
    return ids;
  }

  // --------- UI bind ----------
  function bindUI(){
    byId('btnNew').addEventListener('click', function(){
      DATA = defaultData();
     syncPrestartToStartData();
     syncUIFromData();
     renderAll();
    });

    byId('btnExport').addEventListener('click', exportJson);
    byId('btnImport').addEventListener('click', function(){
      byId('fileImport').click();
    });
    byId('fileImport').addEventListener('change', importJsonFile);

    // meta
    byId('metaTitle').addEventListener('input', function(){ DATA.meta.title = this.value; });
    byId('metaSubtitle').addEventListener('input', function(){ DATA.meta.subtitle = this.value; });
    byId('metaVersion').addEventListener('input', function(){ DATA.meta.version = this.value; });

    byId('metaCharactersEnabled').addEventListener('change', function(){
      var enabled = !!this.checked;
      byId('metaCharactersBox').style.display = enabled ? 'block' : 'none';
      if(enabled){
        if(!DATA.meta.characters) DATA.meta.characters = { enabled:true, source:'personages.json' };
        DATA.meta.characters.enabled = true;
      }else{
        // We bewaren niets: bij export wordt het veld weggelaten (clean)
        delete DATA.meta.characters;
      }
    });
    byId('metaCharactersSource').addEventListener('input', function(){
      if(!DATA.meta.characters) DATA.meta.characters = { enabled:true, source:'personages.json' };
      DATA.meta.characters.source = this.value;
    });

    // settings
    byId('setVisibilityMode').addEventListener('change', function(){ DATA.settings.visibilityMode = this.value; validateAndRender(); });
    byId('setMultiLocSlotMode').addEventListener('change', function(){ DATA.settings.multiLocationSlotMode = this.value; validateAndRender(); });
    byId('setShowOptionalSlots').addEventListener('change', function(){ DATA.settings.showOptionalSlots = !!this.checked; });
    byId('setListShowFutureSlots').addEventListener('change', function(){ DATA.settings.listShowFutureSlots = !!this.checked; });
    byId('setMapShowFutureLocations').addEventListener('change', function(){ DATA.settings.mapShowFutureLocations = !!this.checked; });

    // prestart
    byId('preUseLocationId').addEventListener('change', function(){ DATA.prestart.useLocationId = this.value; validateAndRender(); });
    byId('preMeetingLabel').addEventListener('input', function(){ DATA.prestart.meetingPoint.label = this.value; renderMeetingMarker(); });
    byId('preMeetingLat').addEventListener('input', function(){ DATA.prestart.meetingPoint.lat = parseFloat(this.value||0); renderMeetingMarker(); });
    byId('preMeetingLng').addEventListener('input', function(){ DATA.prestart.meetingPoint.lng = parseFloat(this.value||0); renderMeetingMarker(); });
    byId('preMessage').addEventListener('input', function(){ DATA.prestart.message = this.value; });
    byId('preMapsLabel').addEventListener('input', function(){ DATA.prestart.maps.label = this.value; });

    byId('btnSetMeetingPoint').addEventListener('click', function(){
      meetingPickMode = true;
      alert('Klik nu op de kaart om het meeting point te zetten.');
    });
    byId('btnMakePrestartStartSlot').addEventListener('click', function(){
    makePrestartStartSlot();
    });
    // prestart en start synchroniseren
      byId('preUseLocationId').addEventListener('change', function(){
        DATA.prestart.useLocationId = this.value;
        syncPrestartToStartData();
        renderAll();
      });

      byId('preMeetingLat').addEventListener('input', function(){
        DATA.prestart.meetingPoint.lat = parseFloat(this.value||0);
        syncPrestartToStartData();
        renderAll();
      });

      byId('preMeetingLng').addEventListener('input', function(){
        DATA.prestart.meetingPoint.lng = parseFloat(this.value||0);
        syncPrestartToStartData();
        renderAll();
      });

      byId('preMeetingLabel').addEventListener('input', function(){
        DATA.prestart.meetingPoint.label = this.value;
        syncPrestartToStartData();
        renderAll();
      });
      byId('btnSyncPrestartStart').addEventListener('click', function(){
        syncPrestartToStartDataNonDestructive();
        syncUIFromData();
        renderAll();
      });


    // slots
byId('btnAddSlot').addEventListener('click', function(){
  var id = uniqueId('stop', DATA.slots, 'id');

  // default unlockAfterSlot = vorige required slot (als dat bestaat), anders leeg
       var prevId = '';
      for(var p = DATA.slots.length - 1; p >= 0; p--){
      var prev = DATA.slots[p];
      if(prev && prev.id && prev.required){
        prevId = prev.id;
        break;
      }
}


  var newSlot = { id:id, label:id, required:true };
  if(prevId) newSlot.unlockAfterSlot = prevId; // ‚úÖ ketting-default

  DATA.slots.push(newSlot);

  renderSlotsTable();
  renderLocsTable();
  validateAndRender();
});


  }

  function setMeetingPoint(lat,lng){
    DATA.prestart.meetingPoint.lat = lat;
    DATA.prestart.meetingPoint.lng = lng;
    byId('preMeetingLat').value = lat;
    byId('preMeetingLng').value = lng;
  }
  function ensureStartSlot(){
  // bestaat slot 'start'?
  for(var i=0;i<DATA.slots.length;i++){
    if(DATA.slots[i] && DATA.slots[i].id === 'start') return;
  }
  // voeg startslot toe (vooraan)
  DATA.slots.unshift({ id:'start', label:'Start', required:true });
}
function syncPrestartToStartData(){
  if(!DATA.prestart) DATA.prestart = defaultData().prestart;

  // 1) Zorg dat startslot bestaat (en liefst als eerste)
  var hasStart = false;
  for(var i=0;i<DATA.slots.length;i++){
    if(DATA.slots[i] && DATA.slots[i].id === 'start'){ hasStart = true; break; }
  }
  if(!hasStart){
    DATA.slots.unshift({ id:'start', label:'Start', required:true });
  }else{
    // optioneel: zet start naar voren (comment out als je dit niet wil)
    // var idx=-1;
    // for(var j=0;j<DATA.slots.length;j++) if(DATA.slots[j] && DATA.slots[j].id==='start'){ idx=j; break; }
    // if(idx>0){ var s=DATA.slots.splice(idx,1)[0]; DATA.slots.unshift(s); }
  }

  // 2) Bepaal startlocatie-id
  var startLocId = DATA.prestart.useLocationId;
  if(!startLocId){
    // kies een nette default id
    startLocId = 'startloc';
    var n=1;
    while(findLocById(startLocId)){
      n++;
      startLocId = 'startloc' + n;
    }
    DATA.prestart.useLocationId = startLocId;
  }

  // 3) Zorg dat startlocatie bestaat
  var loc = findLocById(startLocId);
  if(!loc){
    loc = {
      id: startLocId,
      slot: 'start',
      naam: 'Start',
      lat: null,
      lng: null,
      radius: 50,
      images: [],
      routeHint: '',
      uitleg: { kort:'', uitgebreid:'' },
      vragen: []
    };
    DATA.locaties.unshift(loc); // bovenaan
  }

  // 4) Forceer dat die locatie aan slot "start" hangt
  loc.slot = 'start';

  // 5) Synchroniseer gegevens vanuit prestart
  var mp = DATA.prestart.meetingPoint;
  if(mp){
    if(mp.lat != null) loc.lat = mp.lat;
    if(mp.lng != null) loc.lng = mp.lng;

    // naam is smaak: ik zou label hergebruiken als die bestaat
    if(mp.label){
      loc.naam = 'Start: ' + mp.label;
    }else if(!loc.naam || loc.naam === 'Start'){
      loc.naam = 'Start';
    }

    // Als meetingPoint geen lat/lng heeft maar locatie wel, vul meetingPoint dan terug
    if((mp.lat == null || mp.lng == null) && (loc.lat != null && loc.lng != null)){
      mp.lat = loc.lat; mp.lng = loc.lng;
    }
  }else{
    // Als meetingPoint ontbreekt, maak er een op basis van locatie
    DATA.prestart.meetingPoint = { lat: loc.lat, lng: loc.lng, label: 'Start' };
  }
}
function syncPrestartToStartDataNonDestructive(){
  if(!DATA) return;

  // Zorg dat blokken bestaan
  if(!DATA.meta) DATA.meta = { title:'(import)', subtitle:'', version:'1.0' };
  if(!DATA.settings) DATA.settings = defaultData().settings;
  if(!DATA.prestart) DATA.prestart = defaultData().prestart;
  if(!DATA.slots) DATA.slots = [];
  if(!DATA.locaties) DATA.locaties = [];

  // 1) Startslot: enkel toevoegen als het ontbreekt
  var hasStartSlot = false;
  for(var i=0;i<DATA.slots.length;i++){
    if(DATA.slots[i] && DATA.slots[i].id === 'start'){ hasStartSlot = true; break; }
  }
  if(!hasStartSlot){
    DATA.slots.unshift({ id:'start', label:'Start', required:true });
  }

  // 2) Bepaal startlocatie-id: enkel invullen als leeg
  var startLocId = (DATA.prestart && DATA.prestart.useLocationId) ? DATA.prestart.useLocationId : '';
  if(!startLocId){
    // kies een id die nog niet bestaat
    var base = 'startloc';
    var id = base;
    var n = 1;
    while(findLocById(id)){
      n++;
      id = base + n;
    }
    startLocId = id;
    DATA.prestart.useLocationId = startLocId;
  }

  // 3) Startlocatie: enkel aanmaken als ze niet bestaat
  var loc = findLocById(startLocId);
  if(!loc){
    loc = {
      id: startLocId,
      slot: 'start',
      naam: 'Start',
      lat: null,
      lng: null,
      radius: 50,
      images: [],
      routeHint: '',
      uitleg: { kort:'', uitgebreid:'' },
      vragen: []
    };
    DATA.locaties.unshift(loc);
  } else {
    // slot enkel zetten als het leeg is (niet overschrijven)
    if(!loc.slot) loc.slot = 'start';
  }

  // 4) meetingPoint: enkel aanvullen als ontbreekt/onklaar
  if(!DATA.prestart.meetingPoint){
    DATA.prestart.meetingPoint = { lat:null, lng:null, label:'Start' };
  }
  var mp = DATA.prestart.meetingPoint;

  if(!mp.label) mp.label = 'Start';

  // Vul mp lat/lng aan vanuit locatie als mp leeg is
  if((mp.lat == null || mp.lng == null) && (loc.lat != null && loc.lng != null)){
    if(mp.lat == null) mp.lat = loc.lat;
    if(mp.lng == null) mp.lng = loc.lng;
  }

  // Vul locatie lat/lng aan vanuit mp als locatie leeg is
  if((loc.lat == null || loc.lng == null) && (mp.lat != null && mp.lng != null)){
    if(loc.lat == null) loc.lat = mp.lat;
    if(loc.lng == null) loc.lng = mp.lng;
  }

  // Radius: enkel zetten als ontbreekt
  if(loc.radius == null) loc.radius = 50;

  // Naam: enkel zetten als leeg
  if(!loc.naam) loc.naam = 'Start';
}

function getFirstStartLocationId(){
  // zoekt eerste locatie met slot 'start'
  for(var i=0;i<DATA.locaties.length;i++){
    var l = DATA.locaties[i];
    if(l && l.slot === 'start' && l.id) return l.id;
  }
  return null;
}

function createStartLocationFromMeetingPoint(){
  var mp = (DATA.prestart && DATA.prestart.meetingPoint) ? DATA.prestart.meetingPoint : null;
  var lat = mp && mp.lat!=null ? mp.lat : 51.220418;
  var lng = mp && mp.lng!=null ? mp.lng : 4.440854;

  // kies een nette id die nog niet bestaat
  var base = 'startloc';
  var id = base;
  var n = 1;
  while(findLocById(id)){
    n++;
    id = base + n;
  }

  var naam = 'Startlocatie';
  if(mp && mp.label) naam = 'Start: ' + mp.label;

  var loc = {
    id: id,
    slot: 'start',
    naam: naam,
    lat: lat,
    lng: lng,
    radius: 50,
    images: [],
    routeHint: '',
    uitleg: { kort:'', uitgebreid:'' },
    vragen: []
  };

  DATA.locaties.unshift(loc); // startloc bovenaan
  return id;
}

function makePrestartStartSlot(){
  ensureStartSlot();

  // 1) Zorg dat er een startlocatie bestaat
  var startLocId = getFirstStartLocationId();
  if(!startLocId){
    startLocId = createStartLocationFromMeetingPoint();
  }

  // 2) Koppel prestart aan die startlocatie
  if(!DATA.prestart) DATA.prestart = defaultData().prestart;
  DATA.prestart.useLocationId = startLocId;

  // 3) Sync meetingPoint naar startloc (zodat alles netjes samenvalt)
  var loc = findLocById(startLocId);
  if(loc){
    if(!DATA.prestart.meetingPoint) DATA.prestart.meetingPoint = { lat:loc.lat, lng:loc.lng, label:'Start' };
    DATA.prestart.meetingPoint.lat = loc.lat;
    DATA.prestart.meetingPoint.lng = loc.lng;

    // label enkel invullen als die leeg is
    if(!DATA.prestart.meetingPoint.label){
      DATA.prestart.meetingPoint.label = 'Start';
    }
  }

  // 4) UI refresh
  syncUIFromData();
  renderAll();
}


  // --------- Location add/render ----------
  function getLastRadiusDefault(){
  if(DATA.locaties && DATA.locaties.length){
    var last = DATA.locaties[DATA.locaties.length-1];
    if(last && typeof last.radius === 'number' && !isNaN(last.radius)) return last.radius;
  }
  return 30;
}
  function addLocFromMap(lat,lng){
    var locId = prompt('Locatie id?', uniqueId('loc', DATA.locaties, 'id'));
    if(!locId) return;
    if(findLocById(locId)){
      alert('Deze locatie-id bestaat al.');
      return;
    }

   var sids = slotIds();
    var lastSlotId = (DATA.slots && DATA.slots.length && DATA.slots[DATA.slots.length-1].id)
      ? DATA.slots[DATA.slots.length-1].id
      : 'start';

    var slot = prompt('Slot id? (bv. start, stop01, end)', lastSlotId);
    if(!slot) slot = lastSlotId;
    if(!slot) slot = 'start';

    var naam = prompt('Naam?', locId) || locId;

    var loc = {
      id: locId,
      slot: slot,
      naam: naam,
      lat: lat,
      lng: lng,
      radius: getLastRadiusDefault(),
      images: [],
      routeHint: '',
      uitleg: { kort:'', uitgebreid:'' },
      vragen: []
    };
    DATA.locaties.push(loc);

    // default prestart.useLocationId if empty and slot==start
    if(!DATA.prestart.useLocationId && slot === 'start'){
      DATA.prestart.useLocationId = locId;
    }

    renderAll();
  }

  function renderMeetingMarker(){
    var mp = DATA.prestart.meetingPoint;
    if(!mp || mp.lat==null || mp.lng==null) return;
    if(!meetingMarker){
      meetingMarker = L.marker([mp.lat, mp.lng], { draggable:true });
      meetingMarker.addTo(map);
      meetingMarker.on('drag', function(ev){
        var ll = ev.target.getLatLng();
        setMeetingPoint(ll.lat, ll.lng);
      });
      meetingMarker.on('dragend', function(ev){
        var ll = ev.target.getLatLng();
        setMeetingPoint(ll.lat, ll.lng);
      });
    }
    meetingMarker.setLatLng([mp.lat, mp.lng]);
    var txt = mp.label ? mp.label : 'Meeting point';
    meetingMarker.bindPopup('<b>'+esc(txt)+'</b>').closePopup();
  }
function makeLabeledIcon(id, slot){
  var txt = (id || '') + (slot ? (' ‚Ä¢ ' + slot) : '');
  return L.divIcon({
    className: 'locLabelIcon',
    html: '<div class="locLabelBubble">'+esc(txt)+'</div>',
    iconSize: [1,1]
  });
}

  function renderLocMarkers(){
    markerLayer.clearLayers();
    locRender = {};

    for(var i=0;i<DATA.locaties.length;i++){
      (function(){
        var loc = DATA.locaties[i];
        if(!loc || loc.lat==null || loc.lng==null) return;

        var m = L.marker([loc.lat, loc.lng], {
        draggable:true,
        icon: makeLabeledIcon(loc.id, loc.slot)
      });

        m.addTo(markerLayer);

        var c = L.circle([loc.lat, loc.lng], { radius: (loc.radius||50), weight:1, fillOpacity:0.08 });
        c.addTo(markerLayer);

        m.on('drag', function(ev){
          var ll = ev.target.getLatLng();
          loc.lat = ll.lat;
          loc.lng = ll.lng;
          c.setLatLng(ll);
          renderLocsTable(); // refresh lat/lng display
        });
        m.on('dragend', function(ev){
          var ll = ev.target.getLatLng();
          loc.lat = ll.lat;
          loc.lng = ll.lng;
          c.setLatLng(ll);
          validateAndRender();
        });

        m.on('click', function(){
          openLocEditor(loc.id);
        });

        var popup = '<b>'+esc(loc.naam||loc.id)+'</b><br><span class="mini">'+esc(loc.id)+' ¬∑ slot='+esc(loc.slot||'')+'</span>';
        m.bindPopup(popup);

        locRender[loc.id] = { marker:m, circle:c };
      })();
    }
  }

  // --------- Tables ----------
  function renderSlotsTable(){
    var tb = byId('slotsTable').querySelector('tbody');
    var html = '';
    var sids = slotIds();

    for(var i=0;i<DATA.slots.length;i++){
      var s = DATA.slots[i];
      if(!s) continue;

      html += '<tr>';
      html += '<td><input data-i="'+i+'" data-k="id" class="slotInp" type="text" value="'+esc(s.id||'')+'"></td>';
      html += '<td><input data-i="'+i+'" data-k="label" class="slotInp" type="text" value="'+esc(s.label||'')+'"></td>';
      html += '<td style="text-align:center"><input data-i="'+i+'" data-k="required" class="slotChk" type="checkbox" '+(s.required?'checked':'')+'></td>';

      // unlockAfterSlot dropdown (toon alle slots behalve zichzelf)
      html += '<td><select data-i="'+i+'" data-k="unlockAfterSlot" class="slotSel">';
      html += '<option value=""></option>';

      // als import ooit unlockAfterSlot = zichzelf zette: toon dat expliciet als waarschuwing-optie
      if(s.unlockAfterSlot && s.id && s.unlockAfterSlot === s.id){
        html += '<option value="'+esc(s.id)+'" selected>‚ö† '+esc(s.id)+' (ongeldig: zichzelf)</option>';
      }

      for(var j=0;j<sids.length;j++){
        var sid = sids[j];

        // voorkom self-reference
        if(s.id && sid === s.id) continue;

        var sel = (s.unlockAfterSlot === sid) ? 'selected' : '';
        html += '<option value="'+esc(sid)+'" '+sel+'>'+esc(sid)+'</option>';
      }
      html += '</select></td>';


      // completeMode
      html += '<td><select data-i="'+i+'" data-k="completeMode" class="slotSel">';
      var modes = ['', 'all', 'any', 'nearest', 'random'];
      for(var k=0;k<modes.length;k++){
        var mv = modes[k];
        var sel2 = (s.completeMode===mv) ? 'selected' : '';
        html += '<option value="'+esc(mv)+'" '+sel2+'>'+esc(mv)+'</option>';
      }
      html += '</select></td>';

      html += '<td style="text-align:right"><span class="linklike" data-del-slot="'+i+'">verwijder</span></td>';
      html += '</tr>';
    }
    tb.innerHTML = html;

    // bind slot inputs
    var inps = tb.querySelectorAll('.slotInp');
    for(var a=0;a<inps.length;a++){
   inps[a].addEventListener('input', function(){
  var i = parseInt(this.getAttribute('data-i'),10);
  var k = this.getAttribute('data-k');
  DATA.slots[i][k] = this.value;
  // alleen lichte dingen:
  validateAndRender();
});

inps[a].addEventListener('blur', function(){
  // nu pas dropdowns etc. heropbouwen
  renderSlotsTable();
  renderLocsTable();
  renderPrestartUseLocationDropdown();
  validateAndRender();
});

    }
    var chks = tb.querySelectorAll('.slotChk');
    for(var b=0;b<chks.length;b++){
      chks[b].addEventListener('change', function(){
        var i = parseInt(this.getAttribute('data-i'),10);
        DATA.slots[i].required = !!this.checked;
        validateAndRender();
      });
    }
    var sels = tb.querySelectorAll('.slotSel');
    for(var c2=0;c2<sels.length;c2++){
      sels[c2].addEventListener('change', function(){
        var i = parseInt(this.getAttribute('data-i'),10);
        var k = this.getAttribute('data-k');
        var v = this.value;
        if(v==='') delete DATA.slots[i][k];
        else DATA.slots[i][k] = v;
        validateAndRender();
      });
    }

    // delete slot
    var dels = tb.querySelectorAll('[data-del-slot]');
    for(var d=0;d<dels.length;d++){
      dels[d].addEventListener('click', function(){
        var idx = parseInt(this.getAttribute('data-del-slot'),10);
        if(!confirm('Slot verwijderen? (locaties die ernaar verwijzen blijven bestaan)')) return;
        DATA.slots.splice(idx,1);
        renderAll();
      });
    }
  }

  function renderLocsTable(){
    var tb = byId('locsTable').querySelector('tbody');
    var html = '';
    var sids = slotIds();

    for(var i=0;i<DATA.locaties.length;i++){
      var l = DATA.locaties[i];
      if(!l) continue;

      var latlng = (l.lat!=null && l.lng!=null) ? (l.lat.toFixed(6)+', '+l.lng.toFixed(6)) : '';
      html += '<tr>';
      html += '<td><input data-i="'+i+'" data-k="id" class="locInp" type="text" value="'+esc(l.id||'')+'"></td>';

      html += '<td><select data-i="'+i+'" data-k="slot" class="locSel">';
      html += '<option value=""></option>';
      for(var j=0;j<sids.length;j++){
        var sid = sids[j];
        var sel = (l.slot===sid) ? 'selected' : '';
        html += '<option value="'+esc(sid)+'" '+sel+'>'+esc(sid)+'</option>';
      }
      html += '</select></td>';

      html += '<td><input data-i="'+i+'" data-k="naam" class="locInp" type="text" value="'+esc(l.naam||'')+'"></td>';
      html += '<td><input data-i="'+i+'" data-k="radius" class="locNum" type="number" step="1" value="'+esc(l.radius||50)+'"></td>';

      html += '<td class="mini"><span class="linklike" data-zoom="'+esc(l.id)+'">'+esc(latlng)+'</span></td>';
      html += '<td style="text-align:right"><span class="linklike" data-edit="'+esc(l.id)+'">edit</span> ¬∑ <span class="linklike" data-del-loc="'+i+'">verwijder</span></td>';
      html += '</tr>';
    }
    tb.innerHTML = html;

    var inps = tb.querySelectorAll('.locInp');
    for(var a=0;a<inps.length;a++){
      inps[a].addEventListener('input', function(){
        var i = parseInt(this.getAttribute('data-i'),10);
        var k = this.getAttribute('data-k');
        DATA.locaties[i][k] = this.value;

        // als id wijzigt: render markers opnieuw (mapping op id)
        renderAll();
      });
    }
    var nums = tb.querySelectorAll('.locNum');
    for(var b=0;b<nums.length;b++){
      nums[b].addEventListener('input', function(){
        var i = parseInt(this.getAttribute('data-i'),10);
        var k = this.getAttribute('data-k');
        var v = parseFloat(this.value||0);
        DATA.locaties[i][k] = v;

        // update circle live
        var loc = DATA.locaties[i];
        var rr = locRender[loc.id];
        if(rr && rr.circle) rr.circle.setRadius(v||0);

        validateAndRender();
      });
    }
    var sels = tb.querySelectorAll('.locSel');
    for(var c=0;c<sels.length;c++){
      sels[c].addEventListener('change', function(){
        var i = parseInt(this.getAttribute('data-i'),10);
        var k = this.getAttribute('data-k');
        DATA.locaties[i][k] = this.value;
        renderPrestartUseLocationDropdown();
        validateAndRender();
      });
    }

    var edits = tb.querySelectorAll('[data-edit]');
    for(var e=0;e<edits.length;e++){
      edits[e].addEventListener('click', function(){
        openLocEditor(this.getAttribute('data-edit'));
      });
    }

    var zooms = tb.querySelectorAll('[data-zoom]');
    for(var z=0;z<zooms.length;z++){
      zooms[z].addEventListener('click', function(){
        zoomToLoc(this.getAttribute('data-zoom'));
      });
    }

    var dels = tb.querySelectorAll('[data-del-loc]');
    for(var d=0;d<dels.length;d++){
      dels[d].addEventListener('click', function(){
        var idx = parseInt(this.getAttribute('data-del-loc'),10);
        if(!confirm('Locatie verwijderen?')) return;
        DATA.locaties.splice(idx,1);
        renderAll();
      });
    }
  }

  function zoomToLoc(locId){
    var rr = locRender[locId];
    if(rr && rr.marker){
      map.setView(rr.marker.getLatLng(), Math.max(map.getZoom(), 16), { animate:true });
      rr.marker.openPopup();
    }
  }

  // Minimal editor (prompt-based v1)
  function openLocEditor(locId){
    var loc = findLocById(locId);
    if(!loc) return;

    var rh = prompt('routeHint', loc.routeHint || '');
    if(rh != null) loc.routeHint = rh;

    var kort = prompt('uitleg.kort', (loc.uitleg && loc.uitleg.kort) ? loc.uitleg.kort : '');
    if(!loc.uitleg) loc.uitleg = { kort:'', uitgebreid:'' };
    if(kort != null) loc.uitleg.kort = kort;

    var uit = prompt('uitleg.uitgebreid', (loc.uitleg && loc.uitleg.uitgebreid) ? loc.uitleg.uitgebreid : '');
    if(uit != null) loc.uitleg.uitgebreid = uit;

    // vragen: quick edit as newline list
    var qtxt = (loc.vragen && loc.vragen.length) ? loc.vragen.join('\n') : '';
    var nq = prompt('vragen (1 per lijn)', qtxt);
    if(nq != null){
      var lines = nq.split('\n');
      var out=[];
      for(var i=0;i<lines.length;i++){
        var t = lines[i].trim();
        if(t) out.push(t);
      }
      loc.vragen = out;
    }

    renderAll();
  }

  // --------- Prestart dropdown ----------
  function renderPrestartUseLocationDropdown(){
    var sel = byId('preUseLocationId');
    var cur = DATA.prestart.useLocationId || '';
    var html = '<option value=""></option>';
    for(var i=0;i<DATA.locaties.length;i++){
      var l = DATA.locaties[i];
      if(!l || !l.id) continue;
      var label = l.id + (l.naam ? ' ‚Äî ' + l.naam : '');
      var s = (cur===l.id) ? 'selected' : '';
      html += '<option value="'+esc(l.id)+'" '+s+'>'+esc(label)+'</option>';
    }
    sel.innerHTML = html;
  }

  // --------- Validation ----------
 function validate(){
  var issues = { errors:[], warns:[], oks:[] };

  // ---- allowed enum values ----
  var ALLOWED_VIS = { nextOnly:true, all:true, allAfterStart:true };
  var ALLOWED_MULTI = { all:true, any:true, nearest:true, random:true };

  var vis = DATA.settings && DATA.settings.visibilityMode;
  if(vis && !ALLOWED_VIS[vis]){
    issues.errors.push('settings.visibilityMode onbekend: ' + vis);
  }

  var ml = DATA.settings && DATA.settings.multiLocationSlotMode;
  if(ml && !ALLOWED_MULTI[ml]){
    issues.errors.push('settings.multiLocationSlotMode onbekend: ' + ml);
  }

  // ---- slots ----
  var seenSlots = {};
  var hasStartSlot = false;

  for(var i=0;i<DATA.slots.length;i++){
    var s = DATA.slots[i];
    if(!s || !s.id) continue;

    if(seenSlots[s.id]){
      issues.errors.push('Dubbele slot id: ' + s.id);
    }
    seenSlots[s.id] = true;

    if(s.id === 'start') hasStartSlot = true;
  }

  if(vis === 'allAfterStart' && !hasStartSlot){
    issues.warns.push('visibilityMode=allAfterStart maar slot "start" bestaat niet.');
  }

  // ---- locaties ----
  var seenLocs = {};
  var locCountBySlot = {};
  var hasStartLocation = false;

  for(var j=0;j<DATA.locaties.length;j++){
    var l = DATA.locaties[j];
    if(!l || !l.id) continue;

    if(seenLocs[l.id]){
      issues.errors.push('Dubbele locatie id: ' + l.id);
    }
    seenLocs[l.id] = true;

    if(l.lat == null || l.lng == null){
      issues.errors.push('Locatie zonder lat/lng: ' + l.id);
    }

    if(l.slot){
      if(!seenSlots[l.slot]){
        issues.errors.push('Locatie ' + l.id + ' verwijst naar onbekend slot: ' + l.slot);
      }
      locCountBySlot[l.slot] = (locCountBySlot[l.slot] || 0) + 1;
    }

    if(l.slot === 'start') hasStartLocation = true;

    if(l.radius != null && l.radius < 10){
      issues.warns.push('Radius < 10m bij locatie ' + l.id);
    }
    if(l.radius != null && l.radius > 1000){
      issues.warns.push('Radius > 1000m bij locatie ' + l.id);
    }
  }

  // ---- unlockAfterSlot ----
  for(var k=0;k<DATA.slots.length;k++){
    var ss = DATA.slots[k];
    if(ss && ss.unlockAfterSlot && !seenSlots[ss.unlockAfterSlot]){
      issues.errors.push(
        'Slot ' + (ss.id || '?') +
        ' unlockAfterSlot bestaat niet: ' + ss.unlockAfterSlot
      );
    }
    if(ss && ss.id && ss.unlockAfterSlot && ss.unlockAfterSlot === ss.id){
    issues.errors.push('Slot ' + ss.id + ' unlockAfterSlot verwijst naar zichzelf.');
}

  }

  // ---- required slots zonder locaties ----
  for(var sid in seenSlots){
    var slotObj = null;
    for(var z=0;z<DATA.slots.length;z++){
      if(DATA.slots[z].id === sid){ slotObj = DATA.slots[z]; break; }
    }
    if(slotObj && slotObj.required && !locCountBySlot[sid]){
      issues.warns.push('Required slot zonder locaties: ' + sid);
    }
    if(slotObj && slotObj.completeMode === 'random' && (locCountBySlot[sid]||0) <= 1){
      issues.warns.push('completeMode=random maar slechts 1 locatie in slot ' + sid);
    }
  }

  // ---- multiLocationSlotMode heeft geen effect ----
  if(ml && ml !== 'all'){
    var anyMulti = false;
    for(var s2 in locCountBySlot){
      if(locCountBySlot[s2] > 1){ anyMulti = true; break; }
    }
    if(!anyMulti){
      issues.warns.push(
        'multiLocationSlotMode=' + ml +
        ' maar geen enkel slot heeft meerdere locaties.'
      );
    }
  }

  // ---- prestart checks (vriendelijk, niet dwingend) ----
  var ps = DATA.prestart || {};
  var psLocId = ps.useLocationId;

  if(psLocId && !seenLocs[psLocId]){
    issues.warns.push(
      'prestart.useLocationId verwijst naar een niet-bestaande locatie (' +
      psLocId + ').'
    );
  }

  // üëâ DE BELANGRIJKSTE: oude / prestart-only stijl detecteren
  if(ps && (!ps.useLocationId || !hasStartSlot || !hasStartLocation)){
    issues.warns.push(
      'Deze route gebruikt een prestart zonder bijhorende startslot/startlocatie. ' +
      'Dit is toegestaan, maar de builder werkt beter na ‚ÄúSync prestart ‚Üí startslot‚Äù.'
    );
  }

  // ---- OK ----
  if(issues.errors.length === 0){
    issues.oks.push('Geen blokkerende fouten gevonden.');
  }

  return issues;
}

  function renderValidation(){
    var v = validate();
    var box = byId('validationBox');
    var html = '';

    if(v.errors.length){
      html += '<div class="err"><b>Fouten</b><ul>';
      for(var i=0;i<v.errors.length;i++) html += '<li>'+esc(v.errors[i])+'</li>';
      html += '</ul></div>';
    }
    if(v.warns.length){
      html += '<div class="warn"><b>Waarschuwingen</b><ul>';
      for(var j=0;j<v.warns.length;j++) html += '<li>'+esc(v.warns[j])+'</li>';
      html += '</ul></div>';
    }
    if(v.oks.length){
      html += '<div class="ok"><b>OK</b><ul>';
      for(var k=0;k<v.oks.length;k++) html += '<li>'+esc(v.oks[k])+'</li>';
      html += '</ul></div>';
    }
    box.innerHTML = html || '<span class="mini">Nog niets om te valideren.</span>';
  }

  function validateAndRender(){
    renderValidation();
  }

  // --------- Import / Export ----------
  function exportJson(){
    // Clone and keep output clean
    var out = JSON.parse(JSON.stringify(DATA));

    // Characters: enkel mee als checkbox aan staat (DATA.meta.characters bestaat)
    if(!out.meta || !out.meta.characters){
      if(out.meta && out.meta.characters) delete out.meta.characters;
    }

    // Strip empty unlockAfterSlot/completeMode for neatness
    for(var i=0;i<out.slots.length;i++){
      var s = out.slots[i];
      if(!s) continue;
      if(!s.unlockAfterSlot) delete s.unlockAfterSlot;
      if(!s.completeMode) delete s.completeMode;
    }

    // Ensure prestart.maps exists
    if(out.prestart && !out.prestart.maps) out.prestart.maps = { label:'' };

    var json = JSON.stringify(out, null, 2);
    var blob = new Blob([json], { type:'application/json' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (out.meta && out.meta.title ? out.meta.title : 'route') + '.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(function(){
      URL.revokeObjectURL(a.href);
      document.body.removeChild(a);
    }, 250);
  }

  function importJsonFile(ev){
    var f = ev.target.files && ev.target.files[0];
    if(!f) return;
    var r = new FileReader();
    r.onload = function(){
      try{
        var obj = JSON.parse(r.result);
        // basic sanity
        if(!obj || typeof obj !== 'object') throw new Error('Geen object');
        if(!obj.meta) obj.meta = { title:'(import)', subtitle:'', version:'1.0' };
        if(!obj.settings) obj.settings = defaultData().settings;
        if(!obj.prestart) obj.prestart = defaultData().prestart;
        if(!obj.slots) obj.slots = [];
        if(!obj.locaties) obj.locaties = [];

        DATA = obj;
        syncUIFromData();
        renderAll();
        fitMapToData();

      }catch(e){
        alert('Import mislukt: ' + (e && e.message ? e.message : e));
      }finally{
        ev.target.value = '';
      }
    };
    r.readAsText(f);
  }

  // --------- Sync UI ----------
  function syncUIFromData(){
    // meta
    byId('metaTitle').value = DATA.meta.title || '';
    byId('metaSubtitle').value = DATA.meta.subtitle || '';
    byId('metaVersion').value = DATA.meta.version || '1.0';

    var hasChars = !!(DATA.meta && DATA.meta.characters);
    byId('metaCharactersEnabled').checked = hasChars;
    byId('metaCharactersBox').style.display = hasChars ? 'block' : 'none';
    byId('metaCharactersSource').value = hasChars ? (DATA.meta.characters.source || 'personages.json') : 'personages.json';

    // settings
    byId('setVisibilityMode').value = DATA.settings.visibilityMode || 'nextOnly';
    byId('setMultiLocSlotMode').value = DATA.settings.multiLocationSlotMode || 'all';
    byId('setShowOptionalSlots').checked = !!DATA.settings.showOptionalSlots;
    byId('setListShowFutureSlots').checked = !!DATA.settings.listShowFutureSlots;
    byId('setMapShowFutureLocations').checked = !!DATA.settings.mapShowFutureLocations;

    // prestart
    byId('preMeetingLabel').value = (DATA.prestart.meetingPoint && DATA.prestart.meetingPoint.label) ? DATA.prestart.meetingPoint.label : '';
    byId('preMeetingLat').value = (DATA.prestart.meetingPoint && DATA.prestart.meetingPoint.lat!=null) ? DATA.prestart.meetingPoint.lat : '';
    byId('preMeetingLng').value = (DATA.prestart.meetingPoint && DATA.prestart.meetingPoint.lng!=null) ? DATA.prestart.meetingPoint.lng : '';
    byId('preMessage').value = DATA.prestart.message || '';
    byId('preMapsLabel').value = (DATA.prestart.maps && DATA.prestart.maps.label) ? DATA.prestart.maps.label : '';
  }

  // --------- Render all ----------
  function renderAll(){
    renderMeetingMarker();
    renderSlotsTable();
    renderLocsTable();
    renderLocMarkers();
    renderPrestartUseLocationDropdown();

    // ensure prestart.useLocationId selected
    if(DATA.prestart && DATA.prestart.useLocationId){
      byId('preUseLocationId').value = DATA.prestart.useLocationId;
    }

    validateAndRender();
  }

    function fitMapToData(){
      var pts = [];

      // meeting point
      if(DATA.prestart && DATA.prestart.meetingPoint){
        var mp = DATA.prestart.meetingPoint;
        if(mp.lat != null && mp.lng != null) pts.push([mp.lat, mp.lng]);
      }

      // locaties
      for(var i=0;i<DATA.locaties.length;i++){
        var l = DATA.locaties[i];
        if(l && l.lat != null && l.lng != null) pts.push([l.lat, l.lng]);
      }

      if(!pts.length) return;

      try{
        var bounds = L.latLngBounds(pts);
        map.fitBounds(bounds, { padding:[30,30], animate:true });
      }catch(e){}
    }


  // --------- Init ----------
  bindUI();
  // syncUIFromData();
  // renderAll();
  makePrestartStartSlot();

})();
</script>
</body>
</html>
